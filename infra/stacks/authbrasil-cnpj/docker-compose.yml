version: "3.8"

services:
  api:
    image: authbrasil/api:latest
    env_file:
      - .env
    environment:
      # Environment
      ENVIRONMENT: production
      DEBUG: "False"
      
      # Database (usar secrets em produção real)
      DATABASE_URL: postgresql+asyncpg://authbrasil_user:${DB_PASSWORD}@postgres:5432/authbrasil_cnpj
      DATABASE_POOL_SIZE: 20
      DATABASE_MAX_OVERFLOW: 40
      
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      
      # API
      API_VERSION: v1
      CORS_ORIGINS: '["https://app.authbrasil.app.br","http://localhost:3000"]'
      
      # Email
      EMAIL_FROM: noreply@authbrasil.com.br
      EMAIL_PROVIDER: sendgrid
      
      # Note: SECRET_KEY, JWT_SECRET_KEY, STRIPE_*, SENDGRID_API_KEY 
      # são carregadas do .env via env_file acima
      
      # Rate Limiting
      RATE_LIMIT_PER_MINUTE: 100
      RATE_LIMIT_LOGIN_ATTEMPTS: 5
    networks:
      - network_public
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"
        
        # Router HTTP
        - "traefik.http.routers.authbrasil-api.rule=Host(`api.authbrasil.app.br`)"
        - "traefik.http.routers.authbrasil-api.entrypoints=websecure"
        - "traefik.http.routers.authbrasil-api.priority=1"
        - "traefik.http.routers.authbrasil-api.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.authbrasil-api.service=authbrasil-api"
        
        # Service
        - "traefik.http.services.authbrasil-api.loadbalancer.server.port=8000"
        - "traefik.http.services.authbrasil-api.loadbalancer.sticky.cookie=true"
        - "traefik.http.services.authbrasil-api.loadbalancer.sticky.cookie.name=authbrasil_api_lb"
        
        # Middlewares
        - "traefik.http.middlewares.authbrasil-compress.compress=true"
        - "traefik.http.middlewares.authbrasil-ratelimit.ratelimit.average=100"
        - "traefik.http.middlewares.authbrasil-ratelimit.ratelimit.burst=50"
        
        # Security Headers
        - "traefik.http.middlewares.authbrasil-headers.headers.framedeny=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.browserxssfilter=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.contenttypenosniff=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.forcestsheader=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.stsincludesubdomains=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.stspreload=true"
        - "traefik.http.middlewares.authbrasil-headers.headers.stsseconds=31536000"
        
        # Apply middlewares
        - "traefik.http.routers.authbrasil-api.middlewares=authbrasil-compress,authbrasil-ratelimit,authbrasil-headers"

  frontend:
    image: authbrasil/frontend:latest
    env_file:
      - .env
    environment:
      NEXT_PUBLIC_API_URL: https://api.authbrasil.app.br/api/v1
    networks:
      - network_public
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"
        - "traefik.http.routers.authbrasil-frontend.rule=Host(`app.authbrasil.app.br`)"
        - "traefik.http.routers.authbrasil-frontend.entrypoints=websecure"
        - "traefik.http.routers.authbrasil-frontend.priority=1"
        - "traefik.http.routers.authbrasil-frontend.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.authbrasil-frontend.service=authbrasil-frontend"
        - "traefik.http.services.authbrasil-frontend.loadbalancer.server.port=3000"

networks:
  network_public:
    external: true
    name: network_public
