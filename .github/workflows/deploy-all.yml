name: Deploy All

on:
  workflow_dispatch:  # Apenas manual

jobs:
  deploy-databases:
    runs-on: self-hosted
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‚ Deploy Stack Config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "infra/stacks/databases/*"
          target: "/tmp/databases/"
          strip_components: 3

      - name: ðŸ—„ï¸ Deploy Databases
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/databases
            cp /tmp/databases/docker-compose.yml .
            cat > .env << 'EOF'
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            PGADMIN_EMAIL=admin@authbrasil.com.br
            EOF
            docker stack deploy -c docker-compose.yml databases
            echo "âœ… Databases deployed"

  deploy-backend:
    runs-on: self-hosted
    needs: deploy-databases
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‚ Create deployment package
        run: |
          # Criar pacote incluindo TUDO
          tar -czf backend-deploy.tar.gz backend/

      - name: ðŸš€ Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend-deploy.tar.gz,infra/stacks/authbrasil-cnpj/*"
          target: "/tmp/"

      - name: ðŸ”„ Build & Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /opt/authbrasil/authbrasil-cnpj
            
            # Extrair backend
            tar -xzf /tmp/backend-deploy.tar.gz -C /opt/authbrasil/authbrasil-cnpj/
            
            # Build image
            cd backend
            docker build -t authbrasil/api:latest .
            
            # Migrations
            docker run --rm --network network_public \
              -e DATABASE_URL=postgresql://authbrasil_user:${{ secrets.DB_PASSWORD }}@postgres:5432/authbrasil_cnpj \
              authbrasil/api:latest alembic upgrade head || true
            
            # Deploy
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
            cat > .env << 'EOF'
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            EOF
            
            docker stack deploy -c docker-compose.yml authbrasil
            docker service update --force authbrasil_api
            
            sleep 15
            docker container prune -f
            docker image prune -af --filter "dangling=true"
            
            echo "âœ… Deploy completo!"
            docker service ls
