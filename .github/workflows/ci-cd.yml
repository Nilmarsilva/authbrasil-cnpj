name: CI/CD Complete

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Complete
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          # Detectar o que mudou (com fallback para primeiro commit)
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff-tree --no-commit-id --name-only -r HEAD)
          echo "üìù Arquivos alterados:"
          echo "$CHANGED_FILES"
          
          # Flags de deploy
          DEPLOY_BACKEND=false
          DEPLOY_FRONTEND=false
          DEPLOY_DATABASES=false
          DEPLOY_TRAEFIK=false
          DEPLOY_PORTAINER=false
          
          # Detectar mudan√ßas
          if echo "$CHANGED_FILES" | grep -q "^backend/\|^infra/stacks/authbrasil-cnpj/"; then
            DEPLOY_BACKEND=true
            echo "‚úÖ Backend alterado - ser√° deployado"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            DEPLOY_FRONTEND=true
            echo "‚úÖ Frontend alterado - ser√° deployado"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^infra/stacks/databases/"; then
            DEPLOY_DATABASES=true
            echo "‚úÖ Databases alterado - ser√° deployado"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^infra/stacks/traefik/"; then
            DEPLOY_TRAEFIK=true
            echo "‚úÖ Traefik alterado - ser√° deployado"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^infra/stacks/portainer/"; then
            DEPLOY_PORTAINER=true
            echo "‚úÖ Portainer alterado - ser√° deployado"
          fi
          
          ssh $VPS_USER@$VPS_HOST << ENDSSH
            set -e
            
            echo "üöÄ Iniciando deploy autom√°tico..."
            
            # Ir para diret√≥rio
            cd /opt/authbrasil/authbrasil-cnpj
            
            # Configurar SSH para git
            eval "\$(ssh-agent -s)" > /dev/null
            ssh-add ~/.ssh/github_deploy_key 2>/dev/null
            
            # Atualizar c√≥digo
            echo "üì• Atualizando c√≥digo..."
            git pull origin main
            
            # Criar .env files
            echo "‚öôÔ∏è Configurando vari√°veis..."
            
            # Databases .env
            cat > infra/stacks/databases/.env << 'ENVEOF'
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          PGADMIN_EMAIL=admin@authbrasil.com.br
          ENVEOF
            
            # AuthBrasil .env  
            cat > infra/stacks/authbrasil-cnpj/.env << 'ENVEOF'
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
          ENVEOF
            
            # Deploy condicional
            if [ "$DEPLOY_TRAEFIK" = "true" ]; then
              echo "‚ö° Deploying Traefik..."
              cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/traefik
              docker stack deploy -c docker-compose.yml traefik
            fi
            
            if [ "$DEPLOY_PORTAINER" = "true" ]; then
              echo "üê≥ Deploying Portainer..."
              cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/portainer
              docker stack deploy -c docker-compose.yml portainer
            fi
            
            if [ "$DEPLOY_DATABASES" = "true" ]; then
              echo "üóÑÔ∏è Deploying Databases..."
              cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/databases
              docker stack deploy -c docker-compose.yml databases
            fi
            
            if [ "$DEPLOY_BACKEND" = "true" ]; then
              echo "üèóÔ∏è Building API..."
              cd /opt/authbrasil/authbrasil-cnpj/backend
              docker build -t authbrasil/api:latest . || {
                echo "‚ùå Erro no build da API"
                exit 1
              }
              
              echo "üìä Executando migrations..."
              docker run --rm \
                --network network_public \
                -e DATABASE_URL=postgresql://authbrasil_user:${{ secrets.DB_PASSWORD }}@postgres:5432/authbrasil_cnpj \
                authbrasil/api:latest \
                alembic upgrade head || echo "‚ö†Ô∏è Migrations j√° executadas"
              
              echo "üöÄ Deploying API..."
              cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
              docker stack deploy -c docker-compose.yml authbrasil
            fi
            
            if [ "$DEPLOY_FRONTEND" = "true" ]; then
              echo "üé® Building Frontend..."
              cd /opt/authbrasil/authbrasil-cnpj/frontend
              # TODO: Build e deploy do Next.js quando estiver pronto
              echo "‚ö†Ô∏è Frontend ainda n√£o implementado"
            fi
            
            echo ""
            echo "‚úÖ Deploy completo!"
            echo ""
            echo "üìä Status:"
            docker service ls
            
          ENDSSH

      - name: Wait and Check Health
        run: |
          echo "‚è≥ Aguardando API iniciar..."
          sleep 30
          
          echo "üîç Verificando health..."
          curl -f https://api.authbrasil.app.br/api/v1/health || {
            echo "‚ö†Ô∏è API ainda n√£o respondeu (pode levar alguns minutos)"
          }

      - name: Summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deploy autom√°tico conclu√≠do com sucesso!"
            echo ""
            echo "üåê URLs:"
            echo "  - API: https://api.authbrasil.app.br/api/v1/health"
            echo "  - Docs: https://api.authbrasil.app.br/api/v1/docs"
            echo "  - Portainer: https://portainer.authbrasil.app.br"
            echo "  - pgAdmin: https://pg.authbrasil.app.br"
          else
            echo "‚ùå Falha no deploy"
            exit 1
          fi
