name: ğŸš€ Deploy to Production VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: authbrasil/api
  IMAGE_TAG: latest
  STACK_NAME: authbrasil

jobs:
  deploy:
    name: Deploy Backend & Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ” Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 15m
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸš€ AuthBrasil CNPJ - Production Deploy"
            echo "=========================================="
            echo ""
            
            # ==========================================
            # 1. ATUALIZAR CÃ“DIGO
            # ==========================================
            echo "ğŸ“¦ [1/6] Atualizando cÃ³digo do repositÃ³rio..."
            cd /root/authbrasil-cnpj
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… CÃ³digo atualizado para commit: $(git rev-parse --short HEAD)"
            echo ""
            
            # ==========================================
            # 2. LIMPAR RECURSOS ANTIGOS
            # ==========================================
            echo "ğŸ§¹ [2/6] Limpando recursos Docker antigos..."
            
            # Parar stack atual
            docker stack rm authbrasil 2>/dev/null || true
            echo "â³ Aguardando stack ser removida..."
            sleep 10
            
            # Remover containers parados
            echo "ğŸ—‘ï¸  Removendo containers parados..."
            docker container prune -f
            
            # Remover imagens nÃ£o utilizadas (mantÃ©m Ãºltimas 2)
            echo "ğŸ—‘ï¸  Removendo imagens antigas de authbrasil/api..."
            docker images authbrasil/api --format "{{.ID}}" | tail -n +3 | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "ğŸ—‘ï¸  Removendo imagens antigas de authbrasil/frontend..."
            docker images authbrasil/frontend --format "{{.ID}}" | tail -n +3 | xargs -r docker rmi -f 2>/dev/null || true
            
            # Remover imagens dangling
            echo "ğŸ—‘ï¸  Removendo imagens Ã³rfÃ£s..."
            docker image prune -f
            
            echo "âœ… Limpeza concluÃ­da"
            echo ""
            
            # ==========================================
            # 3. BUILD NOVAS IMAGENS
            # ==========================================
            echo "ğŸ”¨ [3/6] Buildando imagens (backend + frontend)..."
            
            # Backend
            echo "ğŸ“¦ Building backend..."
            cd /root/authbrasil-cnpj/backend
            docker build \
              --no-cache \
              --label "app=authbrasil-api" \
              --label "version=$(git rev-parse --short HEAD)" \
              --label "build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              -t authbrasil/api:latest \
              -t authbrasil/api:$(git rev-parse --short HEAD) \
              .
            
            # Frontend
            echo "ğŸ“¦ Building frontend..."
            cd /root/authbrasil-cnpj/frontend
            docker build \
              --no-cache \
              --build-arg NEXT_PUBLIC_API_URL=https://api.authbrasil.app.br/api/v1 \
              --label "app=authbrasil-frontend" \
              --label "version=$(git rev-parse --short HEAD)" \
              --label "build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              -t authbrasil/frontend:latest \
              -t authbrasil/frontend:$(git rev-parse --short HEAD) \
              .
            
            echo "âœ… Builds concluÃ­dos"
            echo ""
            
            # ==========================================
            # 4. CONFIGURAR ENVIRONMENT
            # ==========================================
            echo "ğŸ“ [4/6] Configurando variÃ¡veis de ambiente..."
            cd /root/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
            
            cat > .env << 'ENVEOF'
            # Database
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            # Redis
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            
            # Security
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            
            # External Services (Placeholder)
            STRIPE_SECRET_KEY=sk_test_placeholder
            STRIPE_PUBLISHABLE_KEY=pk_test_placeholder
            STRIPE_WEBHOOK_SECRET=whsec_placeholder
            SENDGRID_API_KEY=SG_placeholder
            ENVEOF
            
            echo "âœ… VariÃ¡veis configuradas"
            echo ""
            
            # ==========================================
            # 5. DEPLOY DA STACK
            # ==========================================
            echo "ğŸš€ [5/6] Fazendo deploy da stack..."
            cd /root/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
            
            # Exportar variÃ¡veis do .env para o ambiente (necessÃ¡rio para Docker Swarm)
            export $(cat .env | grep -v '^#' | xargs)
            
            docker stack deploy -c docker-compose.yml authbrasil
            
            echo "â³ Aguardando serviÃ§os iniciarem..."
            sleep 20
            
            # Aguardar API estar saudÃ¡vel
            echo "ğŸ” Verificando saÃºde da API..."
            for i in {1..30}; do
              if docker service logs authbrasil_api 2>&1 | grep -q "Application startup complete"; then
                echo "âœ… API iniciada com sucesso!"
                break
              fi
              echo "   Tentativa $i/30..."
              sleep 2
            done
            
            echo ""
            
            # ==========================================
            # 6. VERIFICAÃ‡ÃƒO E RELATÃ“RIO
            # ==========================================
            echo "ğŸ“Š [6/6] Status final dos serviÃ§os:"
            echo ""
            docker service ls
            echo ""
            
            echo "ğŸ¥ SaÃºde dos serviÃ§os:"
            docker service ps authbrasil_api --filter "desired-state=running" --no-trunc
            echo ""
            
            echo "ğŸ“‹ Ãšltimas 20 linhas do log:"
            docker service logs authbrasil_api --tail 20
            echo ""
            
            echo "=========================================="
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "=========================================="
            echo ""
            echo "ğŸ“Œ Commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“Œ Data: $(date)"
            echo ""
            echo "ğŸ“Œ Imagens ativas:"
            docker images authbrasil --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
