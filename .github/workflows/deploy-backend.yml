name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‚ Deploy Backend to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/*"
          target: "/root/"
          rm: true

      - name: ðŸ”„ Build & Update Docker Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            echo "ðŸ—ï¸ Building API image..."
            cd /root/backend
            docker build -t authbrasil/api:latest .
            
            echo "ðŸ“Š Running migrations..."
            docker run --rm \
              --network network_public \
              -e DATABASE_URL=postgresql://authbrasil_user:${{ secrets.DB_PASSWORD }}@postgres:5432/authbrasil_cnpj \
              authbrasil/api:latest \
              alembic upgrade head || echo "âš ï¸ Migrations jÃ¡ executadas"
            
            echo "âš™ï¸ Criando .env..."
            cat > /root/backend/.env << 'EOF'
            DATABASE_URL=postgresql://authbrasil_user:${{ secrets.DB_PASSWORD }}@postgres:5432/authbrasil_cnpj
            REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            EOF
            
            echo "ï¿½ Criando docker-compose para backend..."
            cat > /root/docker-compose.backend.yml << 'EOFYML'
            version: '3.8'
            
            services:
              api:
                image: authbrasil/api:latest
                environment:
                  - NODE_ENV=production
                env_file:
                  - /root/backend/.env
                networks:
                  - network_public
                deploy:
                  mode: replicated
                  replicas: 2
                  placement:
                    constraints:
                      - node.role == manager
                  restart_policy:
                    condition: on-failure
                    delay: 10s
                    max_attempts: 5
                  update_config:
                    parallelism: 1
                    delay: 10s
                    order: start-first
                  labels:
                    - traefik.enable=true
                    - "traefik.http.routers.api.rule=Host(\`api.authbrasil.app.br\`)"
                    - traefik.http.routers.api.entrypoints=websecure
                    - traefik.http.routers.api.tls.certresolver=letsencryptresolver
                    - traefik.http.services.api.loadbalancer.server.port=8000
                    - traefik.docker.network=network_public
                  resources:
                    limits:
                      cpus: '1'
                      memory: 1G
                    reservations:
                      cpus: '0.5'
                      memory: 512M
            
            networks:
              network_public:
                external: true
            EOFYML
            
            echo "ðŸš€ Deploying stack..."
            docker stack deploy -c /root/docker-compose.backend.yml authbrasil
            
            echo "ðŸ”„ Rolling update..."
            sleep 5
            docker service update --force authbrasil_api
            
            echo "â³ Aguardando service atualizar..."
            sleep 15
            
            echo "ðŸ§¹ Limpando..."
            docker container prune -f
            docker image prune -af --filter "dangling=true"
            
            echo "âœ… Backend deployed successfully!"
            
            echo "ðŸ“Š Status dos serviÃ§os:"
            docker service ls
