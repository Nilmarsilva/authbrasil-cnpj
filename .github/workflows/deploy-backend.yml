name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üîÑ Build & Deploy
        run: |
          set -e
          
          echo "üì¶ Copiando c√≥digo para /root/backend..."
          rm -rf /root/backend_backup
          if [ -d "/root/backend" ]; then
            cp -r /root/backend /root/backend_backup
          fi
          
          # Copiar novo c√≥digo
          rsync -av --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' backend/ /root/backend/
          
          echo "üèóÔ∏è Building API image..."
          cd /root/backend
          docker build -t authbrasil/api:latest .
          
          echo "üìä Running migrations..."
          docker run --rm --user root \
            --network network_public \
            -e DATABASE_URL=postgresql://authbrasil_user:${{ secrets.DB_PASSWORD }}@postgres:5432/authbrasil_cnpj \
            -e SECRET_KEY=${{ secrets.SECRET_KEY }} \
            -e JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} \
            -e REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0 \
            -e STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }} \
            -e STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }} \
            -e STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }} \
            -e SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }} \
            authbrasil/api:latest python -m alembic upgrade head || echo "‚ö†Ô∏è Migrations j√° executadas"
          
          echo "üöÄ Deploying stack..."
          docker stack deploy -c /root/docker-compose.backend.yml authbrasil
          
          echo "üîÑ Rolling update..."
          sleep 5
          docker service update --force authbrasil_api
          
          echo "‚è≥ Aguardando service atualizar..."
          sleep 15
          
          echo "üßπ Limpando..."
          docker container prune -f
          docker image prune -f
          
          echo "‚úÖ Backend deployed successfully!"
          echo "üìä Status:"
          docker service ls
