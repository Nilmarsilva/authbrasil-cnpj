name: Deploy Databases

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/stacks/databases/**'
      - '.github/workflows/deploy-databases.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‚ Deploy Stack Config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "infra/stacks/databases/*"
          target: "/tmp/databases/"
          strip_components: 3

      - name: ðŸ”„ Update Docker Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            echo "ðŸ“¦ Atualizando configuraÃ§Ã£o..."
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/databases
            
            # Backup config antiga
            cp docker-compose.yml docker-compose.yml.backup
            
            # Copiar nova config
            cp /tmp/databases/docker-compose.yml .
            rm -rf /tmp/databases
            
            echo "âš™ï¸ Criando .env..."
            cat > .env << 'EOF'
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            PGADMIN_EMAIL=admin@authbrasil.com.br
            EOF
            
            echo "ðŸš€ Deploying stack..."
            docker stack deploy -c docker-compose.yml databases
            
            echo "â³ Aguardando services atualizarem..."
            sleep 10
            
            echo "âœ… Databases deployed successfully!"
            
            echo "ðŸ“Š Status dos serviÃ§os:"
            docker service ls | grep databases
