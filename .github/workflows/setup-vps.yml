name: Setup VPS (Primeira Vez)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Adicionar VPS ao known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Setup Completo da VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            echo "ðŸ”§ Iniciando setup da VPS..."
            
            # 1. Inicializar Swarm
            echo "ðŸ“¦ Inicializando Docker Swarm..."
            docker swarm init --advertise-addr $(hostname -I | awk '{print $1}') || echo "Swarm jÃ¡ inicializado"
            
            # 2. Criar rede
            echo "ðŸŒ Criando rede overlay..."
            docker network create --driver overlay --attachable network_public || echo "Rede jÃ¡ existe"
            
            # 3. Criar volumes
            echo "ðŸ’¾ Criando volumes..."
            docker volume create volume_swarm_certificates || echo "Volume jÃ¡ existe"
            docker volume create portainer_data || echo "Volume jÃ¡ existe"
            
            # 4. Criar secrets
            echo "ðŸ” Criando secrets..."
            echo "${{ secrets.DB_PASSWORD }}" | docker secret create db_password - || echo "Secret jÃ¡ existe"
            echo "${{ secrets.PGADMIN_PASSWORD }}" | docker secret create pgadmin_password - || echo "Secret jÃ¡ existe"
            
            # 5. Criar estrutura de diretÃ³rios
            echo "ðŸ“ Criando estrutura de diretÃ³rios..."
            sudo mkdir -p /opt/authbrasil
            sudo chown -R $USER:$USER /opt/authbrasil
            
            # 6. Clonar repositÃ³rio
            echo "ðŸ“¥ Clonando repositÃ³rio..."
            cd /opt/authbrasil
            if [ -d "authbrasil-cnpj" ]; then
              cd authbrasil-cnpj
              git pull origin main
            else
              git clone https://github.com/Nilmarsilva/authbrasil-cnpj.git
              cd authbrasil-cnpj
            fi
            
            # 7. Configurar .env files
            echo "âš™ï¸ Configurando arquivos .env..."
            
            # Databases .env
            cat > infra/stacks/databases/.env << EOF
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            PGADMIN_EMAIL=admin@authbrasil.com.br
            EOF
            
            # AuthBrasil .env
            cat > infra/stacks/authbrasil-cnpj/.env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            EOF
            
            echo "âœ… Setup da VPS concluÃ­do!"
            echo ""
            echo "ðŸ“Š Status:"
            docker node ls
            docker network ls | grep network_public
            docker volume ls | grep -E 'certificates|portainer'
            docker secret ls
            
          ENDSSH

      - name: Deploy Traefik
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "âš¡ Deployando Traefik..."
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/traefik
            docker stack deploy -c docker-compose.yml traefik
            sleep 10
            docker service ls | grep traefik
          ENDSSH

      - name: Deploy Portainer
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "ðŸ³ Deployando Portainer..."
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/portainer
            docker stack deploy -c docker-compose.yml portainer
            sleep 10
            docker service ls | grep portainer
          ENDSSH

      - name: Deploy Databases
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "ðŸ—„ï¸ Deployando Databases..."
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/databases
            docker stack deploy -c docker-compose.yml databases
            sleep 30
            docker service ls | grep databases
          ENDSSH

      - name: Build e Deploy AuthBrasil API
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "ðŸ—ï¸ Buildando imagem da API..."
            cd /opt/authbrasil/authbrasil-cnpj/backend
            docker build -t authbrasil/api:latest .
            
            echo "ðŸš€ Deployando AuthBrasil API..."
            cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
            docker stack deploy -c docker-compose.yml authbrasil
            
            sleep 20
            docker service ls | grep authbrasil
          ENDSSH

      - name: Verificar Deployment
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo ""
            echo "ðŸ“Š Status Final:"
            echo "============================================"
            docker stack ls
            echo "============================================"
            docker service ls
            echo "============================================"
            echo ""
            echo "âœ… Setup completo!"
            echo ""
            echo "ðŸŒ URLs disponÃ­veis:"
            echo "  - API: https://api.authbrasil.app.br"
            echo "  - Portainer: https://portainer.authbrasil.app.br"
            echo "  - pgAdmin: https://pg.authbrasil.app.br"
          ENDSSH
