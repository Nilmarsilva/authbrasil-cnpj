name: Auto Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'infra/stacks/**'
      - 'backend/**'
      - '.github/workflows/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Adicionar VPS ao known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Detectar mudan√ßas e fazer deploy
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          # Detectar quais arquivos mudaram
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          
          echo "üìù Arquivos alterados:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Conectar na VPS e fazer deploy
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            cd /opt/authbrasil/authbrasil-cnpj
            
            echo "üîÑ Atualizando c√≥digo..."
            
            # Configurar SSH para git
            eval "$(ssh-agent -s)"
            ssh-add ~/.ssh/github_deploy_key 2>/dev/null
            
            git pull origin main
            
            # Detectar quais stacks precisam de update
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
            
            echo "üì¶ Verificando stacks para atualizar..."
            
            # Traefik
            if echo "$CHANGED_FILES" | grep -q "infra/stacks/traefik/"; then
              echo "‚ö° Atualizando Traefik..."
              cd infra/stacks/traefik
              docker stack deploy -c docker-compose.yml traefik
              cd /opt/authbrasil/authbrasil-cnpj
            fi
            
            # Portainer
            if echo "$CHANGED_FILES" | grep -q "infra/stacks/portainer/"; then
              echo "üê≥ Atualizando Portainer..."
              cd infra/stacks/portainer
              docker stack deploy -c docker-compose.yml portainer
              cd /opt/authbrasil/authbrasil-cnpj
            fi
            
            # Databases
            if echo "$CHANGED_FILES" | grep -q "infra/stacks/databases/"; then
              echo "üóÑÔ∏è Atualizando Databases..."
              cd infra/stacks/databases
              docker stack deploy -c docker-compose.yml databases
              cd /opt/authbrasil/authbrasil-cnpj
            fi
            
            # Backend/API
            if echo "$CHANGED_FILES" | grep -q "backend/\|infra/stacks/authbrasil-cnpj/"; then
              echo "üöÄ Atualizando API..."
              
              # Rebuild imagem
              cd backend
              docker build -t authbrasil/api:latest .
              
              # Redeploy
              cd /opt/authbrasil/authbrasil-cnpj/infra/stacks/authbrasil-cnpj
              docker stack deploy -c docker-compose.yml authbrasil
            fi
            
            echo ""
            echo "‚úÖ Deploy autom√°tico conclu√≠do!"
            echo ""
            echo "üìä Status:"
            docker service ls
            
          ENDSSH

      - name: Notificar resultado
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deploy autom√°tico realizado com sucesso!"
          else
            echo "‚ùå Falha no deploy autom√°tico"
            exit 1
          fi
